default(realprecision,38);
count = 0;
do(nf,f = 1, H = 0, flag = 0, res = 0) =
{ my(T, K = bnfinit(nf));
  setrand(1); print(count++);
  T = liftpol(bnrclassfield(bnrinit(K,f), H, flag));
  if (res && T == res,, T);
}

do(y^2+6) \\1
do(y^2+30)
do(y^2-y+10)
do(y^2-y+22)
do(y^2-y+22,,,1) \\5
do(y^2-y+24)
do(y^2-y+30)
do(y^2-y+30,,,1)
RES = if(sizebyte(0)==16, [x^9-24*x^7+(2*y-1)*x^6+495*x^5+(-12*y+6)*x^4-30*x^3+(18*y-9)*x^2+18*x+(-2*y+1)] , [x^9-24*x^7+(-2*y+1)*x^6+495*x^5+(12*y-6)*x^4-30*x^3+(-18*y +9)*x^2+18*x+(2*y-1)]);
do(y^2-y+50,,,,RES)
do(y^2-y+58) \\10
do(y^2-y+58,,,1)
do(y^2-y+595)
do(y^2-y+174)
do(y^2-y+1007)
do(y^2+105) \\15
RES=if(sizebyte(0)==16,[x^3-57*x-1577612,x^9+(564*y+10014)*x^7+(-217354820*y+6928885448)*x^6+(-8770608*y+211263813)*x^5+(1602690050652*y+170145955023576)*x^4+(-6415524257475004*y-2554820865277884)*x^3+(-104464370740172976*y-104773397346198648)*x^2+(31535487664657598208*y-1775093962118974802784)*x+(-1860419801027783067488*y+31594667099883472643872)],[x^3-57*x-1577612,x^9+(-2802715404*y+359226004062)*x^7+(111375538992395684326204*y-17624572487457683278401896)*x^6+(-102182870690352*y+2748670726045509)*x^5+(4782766403641745160427470012*y-139505482447811543964946891368)*x^4+(-139316580367657214975657883388*y+4515622230443894175152543471044)*x^3+(-4943723874157782147600*y+348905615797751107113720)*x^2+(132194540722336015023552*y-10960424139829921545113184)*x+(1860419801027783067488*y-31594667099883472643872)]);
do(y^2-y+825,,,,RES)
do(y^2-y+102)
do(y^2+974)
do(y,[15,[1]])
do(y,[97,[1]]) \\20
do(y^3-y^2+3*y+6)
do(y^3-y^2+1,[6545,1333,2018;0,1,0;0,0,1])

\\do(y^2-y+33515) \\~4 seconds
\\do(y^2-y+246) \\~9 seconds

\\Bill's bug (internal rnfkummer needs optimal conductor)
do(a^4+392*a^2+64*a+37456,[31,8,5,29;0,1,0,0;0,0,1,0;0,0,0,1],Mat(4)) \\23
do(y,[19*7,[1]])

print("sanitize");
do(a^4+392*a^2+64*a+37456,[31,8,5,29;0,1,0,0;0,0,1,0;0,0,0,1],Mat(3)) \\25
bnrclassfield(bnfinit(y^2+6),Mat(2))

\\large compositum
do(y,[vecprod(primes(8)),[1]],2,1)

\\flag 2
do(y^2+6,,,2)
do(y^2-y+22,,,2)
do(y^2-y+58,,,2)
do(y^2-y+10,,,2) \\30
do(y^2-y+24,,,2)
do(y^2-y+50,,,2)

\\bug: correct absolute field, wrong extension
print("correct absolute, incorrect relative extension");
setrand(1);
bnf = bnfinit(y^2+7);
dec = idealprimedec(bnf,37);
bnr = bnrinit(bnf,dec[1]);
pol1 = bnrclassfield(bnr,9)[1]
idealval(bnf,rnfdisc(bnf,pol1)[1],dec[1])
bnr = bnrinit(bnf,dec[2]);
pol2 = bnrclassfield(bnr,9)[1]
idealval(bnf,rnfdisc(bnf,pol2)[1],dec[2])
pol1 != pol2

\\bug: corrupted bnr
bnf = bnfinit(y^3-y^2+1);
bnr = bnrinit(bnf,[6545,1333,2018;0,1,0;0,0,1]);
bnrclassfield(bnr,[2,0;0,2])
bnrclassfield(bnr,[2,1;0,1])

print("examples from doc");
bnf = bnfinit(y^3+14*y-1); bnf.cyc
pol = bnrclassfield(bnf,,1) \\Hilbert class field
rnfdisc(bnf,pol)[1]
bnr = bnrinit(bnf,3*5*7); bnr.cyc
bnrclassfield(bnr,2) \\maximal 2-elementary subextension

print("bad inputs");
bnrclassfield(y^2+6,Mat(2))
bnrclassfield(bnfinit(y^2+6),Mat(1/2))
bnrclassfield(bnfinit(y^2+6),1/2)
bnrclassfield(bnfinit(y^2+6),matid(2))
bnrclassfield(bnfinit(y^2+6),Mat(2),3)
bnrclassfield(bnfinit(y^2+6),Mat(2),-1)
bnrclassfield(vector(6),Mat(2))
bnrclassfield(bnrinit(bnfinit(y,1),[73786976294838212093,[1]]))
